<!DOCTYPE html>
<html>
<head>
    <title>ShareTask - Task Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('ui_home') }}">ShareTask</a>
            <div class="d-flex align-items-center">
                <a href="{{ url_for('ui_home') }}" class="btn btn-outline-light me-2">Home</a>
                <!-- Notifications icon/dropdown -->
                <div class="dropdown me-2">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="notifDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        ðŸ”” <span class="badge bg-danger">{{ unread_count }}</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="notifDropdown" style="min-width: 300px; max-height: 400px; overflow-y: auto;">
                        {% if notifications %}
                        {% for n in notifications[:3] %}
                        <li><a class="dropdown-item {% if not n.read %}fw-bold{% endif %}" href="{{ url_for('ui_notifications') }}">
                            <span class="badge {% if n.type == 'critical' %}bg-danger{% elif n.type == 'warning' %}bg-warning{% else %}bg-info{% endif %}">{{ n.type }}</span>
                            {{ n.message|truncate(80) }} <small>({{ n.timestamp[:10] }})</small>
                        </a></li>
                        {% endfor %}
                        {% if notifications|length > 3 %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center" href="{{ url_for('ui_notifications') }}">View all ({{ notifications|length }})</a></li>
                        {% endif %}
                        {% else %}
                        <li><a class="dropdown-item">No notifications</a></li>
                        {% endif %}
                    </ul>
                </div>
                <a href="{{ url_for('ui_logout') }}" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h3>Task Details: {{ task['title'] }}</h3>
                <a href="{{ url_for('ui_home') }}" class="btn btn-secondary">Back to Tasks</a>
            </div>
            <div class="card-body">
                <p><strong>Owner:</strong> {{ task['owner'] }}</p>
                <p><strong>Description:</strong> {{ task['description'] }}</p>
                <p><strong>Frequency:</strong> {{ task['frequency'] }}</p>
                <p><strong>Due Date:</strong> {{ task['due_date'] }}</p>
                <p><strong>Master Status:</strong> {{ task.get('master_status', 'To Do') }}</p>
                <p><strong>Type:</strong> {{ task.get('task_type', 'normal') }}</p>
                <p><strong>Category:</strong> {{ task.get('category', 'sharing') }} {% if task.get('assign_context') %}- Context: {{ task.get('assign_context') }}{% endif %}</p>
                <h5>Statuses:</h5>
                <ul>
                    {% if task.get('category') == 'assignment' %}
                    {% if task.get('shared_with') %}
                    {% set assignee = task.shared_with[0] %}
                    <li>{{ assignee }}: {{ task.statuses.get(assignee, 'N/A') }}</li>
                    {% else %}
                    <li>{{ task.owner }}: {{ task.statuses.get(task.owner, 'N/A') }}</li>
                    {% endif %}
                    {% else %}
                    {% for u, stat in task['statuses'].items() %}
                    <li>{{ u }}: {{ stat }}</li>
                    {% endfor %}
                    {% endif %}
                </ul>
                <h5>Shared With:</h5>
                <ul>
                    {% for u in task.get('shared_with', []) %}
                    <li>{{ u }}</li>
                    {% endfor %}
                </ul>
                <h5>Comments:</h5>
                <ul>
                    {% for c in task.get('comments', []) %}
                    <li>{{ c['user'] }} @ {{ c['timestamp'][:16] }}: {{ c['comment'] }}</li>
                    {% endfor %}
                </ul>
                {% if task.get('task_type') == 'live' %}
                <h5>Live Status: {{ task.get('live_status', 'N/A') }} <span id="live-timer" class="text-danger"></span></h5>
                <h5>Participants:</h5>
                <ul>
                    {% for p_email, p_data in task.get('participants', {}).items() %}
                    <li>{{ p_email }} (joined: {{ p_data.joined[:16] }}, duration: {{ p_data.duration|default(0)|int }}s)</li>
                    {% endfor %}
                </ul>
                {% endif %}

                <h5>Task History</h5>
                <ul>
                    {% for h in task.get('history', []) %}
                    <li>{{ h.timestamp[:16] }} - {{ h.action|upper }} by {{ h.user }}: {{ h.details }}</li>
                    {% endfor %}
                </ul>

                <!-- Operational supports -->
                <div class="mt-4">
                    <h5>Actions</h5>
                    {% if task['statuses'].get(user_email) == 'Pending' %}
                    <!-- Pending shared task actions -->
                    <div class="mb-3">
                        <form method="POST" action="{{ url_for('ui_accept_shared_task', task_id=task_id) }}" style="display:inline;">
                            <button type="submit" class="btn btn-success">Accept Task</button>
                        </form>
                        <form method="POST" action="{{ url_for('ui_reject_shared_task', task_id=task_id) }}" style="display:inline;" onsubmit="return confirm('Reject this shared task?')">
                            <textarea name="reason" class="form-control form-control-sm d-inline w-75" placeholder="Reason for rejection (required for assignment)" rows="2" required></textarea>
                            <button type="submit" class="btn btn-danger btn-sm">Reject Task</button>
                        </form>
                    </div>
                    {% endif %}
                    <!-- Status update on details (non-live) -->
                    {% if task.get('task_type') != 'live' %}
                    <form method="POST" action="{{ url_for('ui_update_status', task_id=task_id) }}" class="mb-3">
                        <select name="status" class="form-select d-inline w-auto" onchange="this.form.submit()">
                            <option value="To Do" {% if task.get('statuses', {}).get(user_email) == 'To Do' %}selected{% endif %}>To Do</option>
                            <option value="In Progress" {% if task.get('statuses', {}).get(user_email) == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Done" {% if task.get('statuses', {}).get(user_email) == 'Done' %}selected{% endif %}>Done</option>
                        </select>
                    </form>
                    {% endif %}
                    <!-- Reclaim for assignment owner -->
                    {% if task.get('category') == 'assignment' and task['owner'] == user_email and task.get('shared_with') %}
                    <form method="POST" action="{{ url_for('ui_reclaim_task', task_id=task_id) }}" class="mb-3" style="display:inline;">
                        <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Reclaim task?')">Reclaim Task</button>
                    </form>
                    {% endif %}
                    <!-- Share (owner only) -->
                    {% if task['owner'] == user_email %}
                    <form method="POST" action="{{ url_for('ui_share_task', task_id=task_id) }}" class="mb-3">
                        <div class="input-group mb-2">
                            <input type="email" name="share_email" class="form-control" placeholder="Share with email" required>
                            <button type="submit" class="btn btn-success">Share</button>
                        </div>
                        <textarea name="context" class="form-control" placeholder="Additional context/reason for assigning (optional, especially for assignment category)" rows="2"></textarea>
                    </form>
                    {% endif %}
                    <!-- Add Comment -->
                    <form method="POST" action="{{ url_for('ui_add_comment', task_id=task_id) }}" class="mb-3">
                        <textarea name="comment" class="form-control mb-2" placeholder="Add comment/motivation" required></textarea>
                        <button type="submit" class="btn btn-info">Add Comment</button>
                    </form>
                    <!-- Start Live (if applicable and owner) -->
                    {% if task.get('task_type') == 'live' and task['owner'] == user_email %}
                    <form method="POST" action="{{ url_for('ui_start_live_task', task_id=task_id) }}">
                        <div class="input-group">
                            <input type="number" name="duration" class="form-control" placeholder="Duration (mins, optional)">
                            <button type="submit" class="btn btn-warning">Start Live Task</button>
                        </div>
                    </form>
                    {% endif %}
                    <!-- Join/Leave Live -->
                    {% if task.get('task_type') == 'live' and task.get('live_status') == 'running' %}
                    {% if user_email in task.get('participants', {}) %}
                    <form method="POST" action="{{ url_for('ui_leave_live', task_id=task_id) }}" class="mt-2">
                        <button type="submit" class="btn btn-secondary">Leave Live</button>
                    </form>
                    {% else %}
                    <form method="POST" action="{{ url_for('ui_join_live', task_id=task_id) }}" class="mt-2">
                        <button type="submit" class="btn btn-success">Join Live</button>
                    </form>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <script>
        function updateLiveTimer() {
            const timerEl = document.getElementById('live-timer');
            if (timerEl && '{{ task.get("live_status") }}' === 'running' && '{{ task.get("start_time") }}') {
                const start = new Date('{{ task.get("start_time") }}');
                setInterval(() => {
                    let elapsed = Math.floor((Date.now() - start) / 1000);
                    const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
                    const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
                    const s = (elapsed % 60).toString().padStart(2, '0');
                    timerEl.textContent = ` (${h}:${m}:${s} elapsed)`;
                }, 1000);
            }
        }
        updateLiveTimer();
    </script>
    <!-- Bootstrap JS for dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>